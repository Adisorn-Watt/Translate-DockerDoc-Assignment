# Leverage Build Cache

- เมื่อสร้าง image , Docker จะทำตามลำดับขั้นตอนที่ระบุไว้ใน Dockerfile
- เมื่อตรวจสอบคำสั่งแต่ละครั้ง Docker จะทำการหา image ที่เคยมีอยู่แล้วใน Cache ที่สามารถเอามาใช้ได้เลย
  แทนที่จะสร้างใหม่
- ถ้าไม่ต้องการใช้ Cache สามารถเลือกใช้

```
--no-cache=true
```

บนคำสั่ง

```
docker build
```

อย่างไรก็ตามเมื่อใช้คำสั่ง Cache เราจำเป็นจะต้องเข้าใจว่าเมื่อไหร่ที่สามารถและไม่สามารถหา image ที่ตรงกันได้ ซึ่งมีกฎพื้นฐานต่างๆต่อไปนี้:

- เริ่มจาก parent image ที่อยู่ใน cache อยู่แล้ว จากนั้นจะทำการเปรียบเทียบกับ child image ทั้งหมด
  ที่ได้จาก base image เพื่อดูว่า image ใดที่ถูกสร้างมาจากคำสั่งเดียวกัน ถ้าไม่มี cache ก็จะใช้การไม่ได้

- ในกรณีส่วนใหญ่ การเปรียบเทียบคำสั่งใน Dockerfile กับ child image อันใดอันหนึ่งก็พอแล้ว
  แต่ในบางคำสั่ง จำเป็นต้องมีการตรวจสอบและมีคำอธิบายเพิ่มเติมด้วย

- สำหรับคำสั่ง ADD และ COPY , เนื้อหาใน image จะถูกตรวจสอบและมีการคำนวณ checksum ในแต่ละไฟล์
  ซึ่งเวลาที่แก้ไขและเข้าถึงไฟล์ล่าสุดจะไม่ถูกเอามาคิดด้วย

- ในระหว่างการค้นหา cache นั้น checksum นั้นๆจะถูกเปรัยบเทียบกับ checksum ของ image ที่เคยมีอยู่
  หากมีการเปลี่ยนแปลงอะไรบางอย่างในไฟล์ เช่น เนื้อหา และ metadata ดังนั้น cache ก็จะใช้งานไม่ได้

- นอกเหนือจากคำสั่ง ADD และ COPY แล้ว การตรวจสอบ Cache นั้นจะไม่ดูในไฟล์คอนเทนเนอร์เพื่อพิจารณาในการหา cache match

- ยกตัวอย่างเช่น เมื่อรันคำสั่ง

```
RUN apt-get -y update
```

ไฟล์ที่อัพเดทในคอนเทนเนอร์จะไม่ถูกตรวจสอบ ว่ามี cache ที่ตรงกันหรือไม่ แต่เป็นแค่การใช้คำสั่งสตริงเพื่อหาว่ามีข้อมูลที่ตรงกัน

\*\* เมื่อ cache ไม่ตรงกับ image ใดๆที่เราต้องการสร้าง คำสั่ง Dockerfile ทั้งหมดก็จะทำการสร้าง image ขึ้นมาใหม่ และ cache จะไม่ถูกใช้
